<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dept. Resource & Quality Planner</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        /* --- STYLES --- */
        :root { 
            --primary: #2563eb; --qual: #7c3aed; --danger: #dc2626; --warning: #f59e0b; 
            --success: #16a34a; --locked: #6b7280; --bg: #f3f4f6; --card: #ffffff; --border: #e5e7eb; 
            --pto: #9ca3af; 
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #1f2937; }
        .container { max-width: 1600px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; }

        /* Navigation */
        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 20px; background: white; border: 1px solid var(--border); border-radius: 8px; font-weight: 600; cursor: pointer; color: #6b7280; transition: all 0.2s; }
        .tab-btn:hover { background: #f9fafb; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2); }
        .tab-btn.qual-active { background: var(--qual); color: white; border-color: var(--qual); }

        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Controls & Nav */
        .week-nav { display: flex; justify-content: center; align-items: center; gap: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .nav-btn { background: var(--bg); border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
        .nav-btn:hover { background: #e5e7eb; }
        .current-week-display { font-size: 1.2em; font-weight: bold; color: var(--primary); min-width: 250px; text-align: center; }

        .control-panel { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; border-left: 5px solid var(--primary); }
        .qual-panel { border-left-color: var(--qual); }
        .form-group { flex: 1; min-width: 130px; }
        label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.75em; color: #4b5563; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; font-size: 0.9em; }
        .action-btn { background: var(--primary); color: white; border: none; padding: 0 20px; border-radius: 6px; font-weight: bold; cursor: pointer; height: 38px; min-width: 100px; }
        .qual-btn { background: var(--qual); }

        /* Dashboard & Cards */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; }
        .person-card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .card-header { border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { margin: 0; font-size: 1.1em; color: #111827; }

        /* Sample Tracking */
        .samples-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-top: 20px; }
        .sample-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; overflow: hidden; }
        .sample-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .target-input { width: 60px; padding: 4px; text-align: center; border: 1px solid var(--primary); border-radius: 4px; }
        .centered-chart { width: 100%; height: 250px; }

        /* Capacity Bars */
        .bar-container { height: 28px; background: #e5e7eb; border-radius: 4px; overflow: hidden; display: flex; margin: 5px 0; position: relative; }
        .bar-seg { height: 100%; transition: width 0.3s; display:flex; align-items:center; justify-content:center; color:white; font-size:0.75em; font-weight:bold; overflow:hidden; white-space:nowrap; text-shadow: 0px 0px 2px rgba(0,0,0,0.3); }
        .stats-text { display: flex; justify-content: space-between; font-size: 0.8em; color: #666; font-weight: 600; }
        .context-warning { font-size: 0.75em; color: var(--danger); margin-top: 4px; min-height: 1em; }
        
        /* Tasks */
        .task-item { border: 1px solid var(--border); background: white; padding: 10px; margin-bottom: 8px; border-radius: 6px; border-left: 4px solid var(--primary); position: relative; transition: all 0.2s; }
        .task-item.priority-High { border-left-color: var(--danger); }
        .task-item.blocked { border: 2px dashed var(--danger); opacity: 0.8; background: #fef2f2; }
        .task-item.overdue { border: 2px solid var(--danger); box-shadow: 0 0 8px rgba(220, 38, 38, 0.15); }
        .task-item.completed { opacity: 0.6; background: #f0fdf4; border-color: #86efac; border-left-color: #166534; }
        
        /* PTO Styles */
        .task-item.type-PTO, .task-item.type-Holiday { border-left-color: var(--pto); background: #f9fafb; background-image: repeating-linear-gradient(45deg, #f9fafb, #f9fafb 10px, #f3f4f6 10px, #f3f4f6 20px); }
        .task-item.type-PTO .task-desc, .task-item.type-Holiday .task-desc { color: #6b7280; font-style: italic; }

        .task-meta { font-size: 0.75em; color: #6b7280; display: flex; gap: 8px; align-items: center; margin: 4px 0; flex-wrap: wrap; }
        .tag { padding: 2px 6px; border-radius: 4px; background: #eff6ff; color: var(--primary); font-weight: 600; font-size: 0.85em; }
        .tag-late { background: #fee2e2; color: var(--danger); }
        .tag-pto { background: #e5e7eb; color: #374151; }
        .task-notes { width: 100%; background: #f9fafb; padding: 6px; border-radius: 4px; border: 1px dashed #d1d5db; font-size: 0.85em; color: #4b5563; margin-top: 5px; font-style: italic; }
        
        .task-actions { display: flex; gap: 5px; justify-content: flex-end; margin-top: 8px; border-top: 1px solid #f3f4f6; padding-top: 5px; }
        .icon-btn { border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; padding: 4px 8px; font-size: 0.9em; transition:all 0.2s; }
        .icon-btn:hover { background: #f3f4f6; border-color: var(--primary); color: var(--primary); }

        /* Tables & Charts */
        .summary-controls { text-align: center; margin-bottom: 20px; display:flex; justify-content:center; gap:10px; align-items:center; }
        .charts-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .pie-box { width: 100%; max-width: 400px; height: 300px; background: #fff; border: 1px solid #f3f4f6; border-radius: 8px; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid var(--border); }
        th { background: #f9fafb; text-align: left; }
        td:first-child { text-align: left; font-weight: bold; }
        .status-pill { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 25px; width: 500px; border-radius: 8px; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .close-x { float: right; font-size: 24px; cursor: pointer; color: #999; }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 3000; display: flex; justify-content: center; align-items: center; font-size: 1.5em; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div id="loadingOverlay">Loading Data...</div>

<div class="container">
    <header>
        <h1>Dept. Resource & Quality Planner</h1>
        <p>Engineering (Max, Lee, Jordon, Tim) ‚Ä¢ Quality (Ron, Glen)</p>
    </header>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="switchView(event, 'engineering')">Engineering Planner</button>
        <button class="tab-btn" onclick="switchView(event, 'quality')">Quality Planner</button>
        <button class="tab-btn" onclick="switchView(event, 'completed')">Completed History</button>
        <button class="tab-btn" onclick="switchView(event, 'samples')">Sample Tracking</button>
        <button class="tab-btn" onclick="switchView(event, 'calculator')">Job Calculator</button>
        <button class="tab-btn" onclick="switchView(event, 'timestudy')">Time Standards</button>
        <button class="tab-btn" onclick="switchView(event, 'summary')">Executive Dashboard</button>
    </div>

    <div id="engineeringView" class="view-section active">
        <div class="week-nav">
            <button class="nav-btn" onclick="changeWeek(-1)">&lt; Previous Week</button>
            <div class="current-week-display">...</div>
            <button class="nav-btn" onclick="changeWeek(1)">Next Week &gt;</button>
        </div>
        
        <div class="control-panel">
            <div class="form-group">
                <label>Engineer</label>
                <select id="engSelect">
                    <option value="0">Maxwell (Eng 1)</option>
                    <option value="1">Lee (Eng 2)</option>
                    <option value="2">Jordon (Eng 3)</option>
                    <option value="3">Tim (Lab Tech)</option>
                </select>
            </div>
            <div id="engInputs" style="display:contents;"></div>
            <button class="action-btn" onclick="addTask('eng')">+ Add Task / PTO</button>
        </div>
        <div class="dashboard" id="engDashboard"></div>
    </div>

    <div id="qualityView" class="view-section">
        <div class="week-nav">
            <button class="nav-btn" onclick="changeWeek(-1)">&lt; Previous Week</button>
            <div class="current-week-display">...</div>
            <button class="nav-btn" onclick="changeWeek(1)">Next Week &gt;</button>
        </div>

        <div class="control-panel qual-panel">
            <div class="form-group">
                <label>Personnel</label>
                <select id="qualSelect">
                    <option value="4">Ron (Manager)</option>
                    <option value="5">Glen (Tech)</option>
                </select>
            </div>
            <div id="qualInputs" style="display:contents;"></div>
            <button class="action-btn qual-btn" onclick="addTask('qual')">+ Add Task / PTO</button>
        </div>
        <div class="dashboard" id="qualDashboard"></div>
    </div>

    <div id="completedView" class="view-section">
        <div class="person-card">
            <h3>Master Completed History</h3>
            <div style="overflow-x:auto">
                <table id="masterHistoryTable">
                    <thead><tr><th>Engineer</th><th>Task</th><th>Category</th><th>Completed Date</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="samplesView" class="view-section">
        <div class="control-panel">
            <div class="form-group"><label>Date Purchased</label><input type="date" id="sampDate"></div>
            <div class="form-group"><label>Product Line</label><select id="sampProduct"></select></div>
            <div class="form-group"><label>Quantity</label><input type="number" id="sampQty" min="1" value="1"></div>
            <button class="action-btn" onclick="addSampleOrder()">Log Order</button>
        </div>
        <div style="margin-bottom:20px; color:#666;"><strong>Monthly Sample Tracking:</strong> Adjust target in the box.</div>
        <div id="samplesGrid" class="samples-grid"></div>
    </div>

    <div id="calculatorView" class="view-section">
        <div class="calc-box" style="background:white; padding:25px; border-radius:8px; max-width:600px; margin:0 auto;">
            <h3 style="margin-top:0;">Workload Estimator</h3>
            <div class="form-group" style="margin-bottom:15px;"><label>Product</label><select id="calcCat" onchange="updateCalcTasks()"></select></div>
            <div class="form-group" style="margin-bottom:15px;"><label>Task</label><select id="calcType" onchange="runCalc()"></select></div>
            <div class="form-group" style="margin-bottom:15px;"><label>Qty</label><input type="number" id="calcQty" value="1" min="1" onchange="runCalc()"></div>
            <div style="background:#f3f4f6; padding:20px; border-radius:8px; text-align:center; margin:20px 0;">
                <div style="font-size:2.5em; font-weight:bold; color:var(--primary);"><span id="calcResult">0.0</span> hrs</div>
                <div id="calcRate" style="color:#666;"></div>
            </div>
            <button class="action-btn" style="width:100%;" onclick="openAssignModal()">Convert to Task & Assign</button>
        </div>
    </div>

    <div id="timestudyView" class="view-section">
        <div class="person-card">
            <h3>Time Standards</h3>
            <div style="display:flex; gap:15px; margin-bottom:20px;">
                <div class="form-group"><label>Product</label><select id="tsCat" onchange="updateTaskTypes('ts'); renderTimeStudy();"></select></div>
                <div class="form-group"><label>Task Type</label><select id="tsType" onchange="renderTimeStudy()"></select></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div style="background:#f9fafb; padding:15px; border-radius:8px;">
                    <div id="subtaskList"></div>
                    <button class="icon-btn" style="width:100%; margin-top:10px; padding:8px;" onclick="addSubtaskRow()">+ Add Subtask</button>
                    <div style="margin-top:20px; text-align:right; font-weight:bold; font-size:1.2em;">Total: <span id="tsTotal">0</span> hrs</div>
                    <button class="action-btn" style="width:100%; margin-top:15px; background:var(--success);" onclick="saveTimeStudy()">Update Standard & Recalculate</button>
                </div>
                <div><div id="tsChart" style="height:300px;"></div></div>
            </div>
        </div>
    </div>

    <div id="summaryView" class="view-section">
        <div class="summary-controls">
            <label>Year:</label><select id="sumYear" class="year-select" onchange="renderSummary()"><option value="2025">2025</option><option value="2026">2026</option></select>
            <label style="margin-left:20px;">Month:</label><select id="sumMonth" class="year-select" onchange="renderSummary()"><option value="All">Full Year</option><option value="0">Jan</option><option value="1">Feb</option><option value="2">Mar</option><option value="3">Apr</option><option value="4">May</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Aug</option><option value="8">Sep</option><option value="9">Oct</option><option value="10">Nov</option><option value="11">Dec</option></select>
        </div>
        <div class="dashboard">
            <div class="person-card"><h3>Reliability</h3><table id="reliabilityTable"></table></div>
            <div class="person-card"><h3>Top Time Consumers (Individual Tasks)</h3><table id="topTasksTable"></table></div>
        </div>
        <div class="person-card" style="margin-top:20px;"><h3>Task Distribution</h3><div id="pieChartsContainer" class="charts-container"></div></div>
        <div class="dashboard" style="margin-top:20px;">
            <div class="person-card"><h3>Efficiency Loss</h3><div style="overflow-x:auto"><table id="efficiencyTable"></table></div></div>
            <div class="person-card"><h3>Total Hours</h3><div style="overflow-x:auto"><table id="engSummaryTable"></table></div></div>
        </div>
    </div>
</div>

<div id="historyModal" class="modal"><div class="modal-content"><span class="close-x" onclick="closeModal('historyModal')">&times;</span><h3>History</h3><div id="historyLog"></div></div></div>
<div id="blockModal" class="modal"><div class="modal-content"><span class="close-x" onclick="closeModal('blockModal')">&times;</span><h3>Block Task</h3><textarea id="blockReason" placeholder="Reason..."></textarea><button class="action-btn" style="background:var(--danger); width:100%; margin-top:10px;" onclick="confirmBlock()">Block</button></div></div>
<div id="assignModal" class="modal"><div class="modal-content"><span class="close-x" onclick="closeModal('assignModal')">&times;</span><h3>Assign Task</h3><label>To:</label><select id="assignTarget"></select><label>Start</label><input type="date" id="assignStart"><label>Priority</label><select id="assignPriority"><option>Medium</option><option>High</option></select><button class="action-btn" style="width:100%; margin-top:15px;" onclick="confirmAssign()">Assign</button></div></div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close-x" onclick="closeModal('editModal')">&times;</span>
        <h3>Edit Task Details</h3>
        <div class="form-group" style="margin-bottom:15px;"><label>Start Date</label><input type="date" id="editStart"></div>
        <div class="form-group" style="margin-bottom:15px;"><label>Due Date</label><input type="date" id="editEnd"></div>
        <div class="form-group" style="margin-bottom:15px;"><label>Comments / Notes</label><textarea id="editDetails" style="height:80px;"></textarea></div>
        <button class="action-btn" onclick="saveEditTask()" style="width:100%;">Save Changes & Recalculate</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // -----------------------------------------------------------
    // üö® PASTE YOUR FIREBASE CONFIG HERE üö®
    // -----------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyDxQrOoHYKqPn1lJ52NW1XvDB05PpNGwKU",
        authDomain: "engineering-task-tracker.firebaseapp.com",
        projectId: "engineering-task-tracker",
        storageBucket: "engineering-task-tracker.firebasestorage.app",
        messagingSenderId: "881070104494",
        appId: "1:881070104494:web:1ded65fe520f3e5817723f",
        measurementId: "G-5TF7EYQ4YC"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;
    window.dbOps = { doc, updateDoc, arrayUnion, setDoc, getDoc, onSnapshot };

    // --- GLOBAL VARS ---
    window.activeTaskForModal = null; // Ensure global scope

    // --- REPAIR TOOL (Fixes "Late" History) ---
    async function repairLegacyData(personnelList) {
        let fixed = false;
        for(let p of personnelList) {
            let mod = false;
            let tasks = [...p.tasks];
            tasks.forEach(t => {
                if((t.completed || t.isDone) && (t.status === 'Late' || !t.completedDate)) {
                    t.status = 'On Time';
                    if(!t.completedDate) t.completedDate = t.end; 
                    mod = true;
                }
            });
            if(mod) {
                console.log(`Fixing legacy status for ${p.name}...`);
                await window.dbOps.updateDoc(window.dbOps.doc(window.db, "personnel", p.id.toString()), { tasks });
                fixed = true;
            }
        }
        if(fixed) console.log("Legacy data repair complete.");
    }

    async function initDB() {
        const personnel = [
            {id:0, name:"Maxwell", role:"Eng 1", dept:"eng"}, {id:1, name:"Lee", role:"Eng 2", dept:"eng"},
            {id:2, name:"Jordon", role:"Eng 3", dept:"eng"}, {id:3, name:"Tim", role:"Lab Tech", dept:"eng"},
            {id:4, name:"Ron", role:"Quality Mgr", dept:"qual"}, {id:5, name:"Glen", role:"Quality Tech", dept:"qual"}
        ];
        for(let p of personnel) {
            const ref = doc(db, "personnel", p.id.toString());
            if(!(await getDoc(ref)).exists()) await setDoc(ref, {info: p, tasks: []});
        }
        
        const confRef = doc(db, "config", "standards");
        const confSnap = await getDoc(confRef);
        
        if(!confSnap.exists()) {
            await setDoc(confRef, { costs: window.DEFAULT_COSTS, breakdowns: {} });
        } else {
            let dbCosts = confSnap.data().costs || {};
            let updated = false;
            Object.keys(window.DEFAULT_COSTS).forEach(key => {
                if(!dbCosts[key]) { dbCosts[key] = window.DEFAULT_COSTS[key]; updated = true; }
                else {
                    if(!dbCosts[key]["Engineering Design"] && dbCosts[key]["Full Design"]) {
                        dbCosts[key]["Engineering Design"] = dbCosts[key]["Full Design"]; updated = true;
                    } else if (!dbCosts[key]["Engineering Design"]) {
                        dbCosts[key]["Engineering Design"] = window.DEFAULT_COSTS[key]["Engineering Design"]; updated = true;
                    }
                    if(!dbCosts[key]["Product Testing"]) { dbCosts[key]["Product Testing"] = 2; updated = true; }
                }
            });
            if(updated) await updateDoc(confRef, { costs: dbCosts });
        }
        
        if(!(await getDoc(doc(db, "config", "samples"))).exists()) await setDoc(doc(db, "config", "samples"), { orders: [], targets: {} });
    }

    onSnapshot(collection(db, "personnel"), (snap) => {
        window.PERSONNEL = [];
        snap.forEach(d => {
            const data = d.data();
            const tasks = (data.tasks || []).map(t => ({
                ...t,
                start: t.start && t.start.toDate ? t.start.toDate() : new Date(t.start),
                end: t.end && t.end.toDate ? t.end.toDate() : new Date(t.end),
                completedDate: t.completedDate && t.completedDate.toDate ? t.completedDate.toDate() : (t.completedDate ? new Date(t.completedDate) : null)
            }));
            window.PERSONNEL.push({ id: parseInt(d.id), name: data.info.name, role: data.info.role, dept: data.info.dept, tasks: tasks });
        });
        if(!window.repaired) { repairLegacyData(window.PERSONNEL); window.repaired=true; }
        document.getElementById('loadingOverlay').style.display = 'none';
        refreshActiveView();
    });

    onSnapshot(doc(db, "config", "standards"), (d) => {
        if(d.exists()) {
            const data = d.data();
            window.CATEGORY_COSTS = data.costs || window.DEFAULT_COSTS;
            window.TASK_BREAKDOWNS = data.breakdowns || {};
            initDropdowns();
            if(document.getElementById('timestudyView').classList.contains('active')) renderTimeStudy();
        }
    });

    onSnapshot(doc(db, "config", "samples"), (d) => {
        if(d.exists()) {
            window.SAMPLE_ORDERS = d.data().orders || [];
            window.SAMPLE_TARGETS = d.data().targets || {};
            if(document.getElementById('samplesView').classList.contains('active')) renderSamples();
        }
    });

    initDB();
</script>

<script>
    google.charts.load('current', {'packages':['corechart', 'line']});
    let chartsLoaded = false;
    google.charts.setOnLoadCallback(() => { chartsLoaded = true; });

    const TOTAL_CAPACITY = 45;
    const BASELINE_HOURS = 27; // 60% of 45
    const VP_THRESHOLD = 45;
    const MONTHS = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    window.DEFAULT_COSTS = {
        "Air Shocks & Struts": { "Comparison": 3, "Engineering Design": 2, "Product Testing": 2 },
        "Air Compressors": { "Comparison": 4, "Engineering Design": 2, "Product Testing": 2 },
        "Valve Blocks": { "Comparison": 1, "Engineering Design": 1, "Product Testing": 1 },
        "Electric Lift Supports": { "Comparison": 1, "Engineering Design": 1, "Product Testing": 1 },
        "Coil Springs": { "Comparison": 1, "Engineering Design": 1, "Product Testing": 1 },
        "Complete Strut Assemblies": { "Comparison": 2, "Engineering Design": 3, "Product Testing": 2 },
        "Shock Absorbers": { "Comparison": 1, "Engineering Design": 1, "Product Testing": 1 },
        "Fuel Pumps": { "Comparison": 1, "Engineering Design": 2, "Product Testing": 2 },
        "Brake Wear Sensors": { "Comparison": 0.5, "Engineering Design": 1, "Product Testing": 1 },
        "Lift Supports": { "Comparison": 1, "Engineering Design": 1, "Product Testing": 1 },
        "GDI Pumps": { "Comparison": 1, "Engineering Design": 1, "Product Testing": 1 },
        "MAF": { "Comparison": 1, "Engineering Design": 1, "Product Testing": 1 },
        "O2 Sensors": { "Comparison": 1, "Engineering Design": 1, "Product Testing": 1 },
        "Fuel Injectors": { "Comparison": 1, "Engineering Design": 1, "Product Testing": 1 }
    };

    window.CATEGORY_COSTS = JSON.parse(JSON.stringify(window.DEFAULT_COSTS));
    window.TASK_BREAKDOWNS = {};
    window.PERSONNEL = [];
    window.SAMPLE_ORDERS = [];
    window.SAMPLE_TARGETS = {};

    const ENG_TASK_TYPES = ["Comparison", "Engineering Design", "Product Testing", "Attribute Fill-in", "Customer Feedback", "Research Assignment", "Meeting", "Other"];
    const QUAL_TASK_TYPES = ["NAPA Tech Line", "Warranty Claims", "Quarantine", "SOPs", "Quality Issues", "Time Studies", "Quality Alerts", "Recalls", "Meeting", "Other"];
    const TASK_COLORS = { "Comparison":"#4285F4", "Engineering Design":"#34A853", "Product Testing":"#FBBC05", "PTO":"#9ca3af", "Holiday":"#9ca3af" };

    let currentWeekStart = getMonday(new Date());

    document.addEventListener('DOMContentLoaded', () => {
        const buildInputs = (id) => `
            <div class="form-group"><label>Product</label><select id="${id}Cat" onchange="updateTaskTypes('${id}')"></select></div>
            <div class="form-group"><label>Task Type</label><select id="${id}Type" onchange="checkManual('${id}')"></select></div>
            <div class="form-group" id="${id}ManualDiv" style="display:none; max-width:80px;"><label>Total Hrs</label><input type="number" id="${id}Manual" step="0.1"></div>
            <div class="form-group" style="max-width:60px;"><label>Qty</label><input type="number" id="${id}Qty" value="1"></div>
            <div class="form-group"><label>Start</label><input type="date" id="${id}Start"></div>
            <div class="form-group"><label>End</label><input type="date" id="${id}End"></div>
            <div class="form-group"><label>Priority</label><select id="${id}Pri"><option>Medium</option><option>High</option><option>Low</option></select></div>
            <div class="form-group" style="flex:2"><label>Notes</label><textarea id="${id}Note"></textarea></div>
        `;
        document.getElementById('engInputs').innerHTML = buildInputs('eng');
        document.getElementById('qualInputs').innerHTML = buildInputs('qual');
        document.querySelectorAll('input[type="date"]').forEach(i => i.value = new Date().toISOString().split('T')[0]);
        updateWeekDisplay();
    });

    function initDropdowns() {
        const products = Object.keys(window.CATEGORY_COSTS).sort();
        ['eng', 'qual', 'calc', 'ts', 'samp'].forEach(pre => {
            const sel = document.getElementById(`${pre}Cat`) || document.getElementById(`${pre}Product`);
            if(sel) {
                const cur = sel.value;
                sel.innerHTML = '';
                products.forEach(p => sel.add(new Option(p, p)));
                if(cur && products.includes(cur)) sel.value = cur;
                else if(products.length>0) sel.value = products[0];
            }
        });
        updateTaskTypes('eng');
        updateTaskTypes('qual');
        updateTaskTypes('ts');
        updateCalcTasks();
    }

    function getMonday(d) { d = new Date(d); var day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1); return new Date(d.setDate(diff)); }
    function addDays(d, n) { var date = new Date(d); date.setDate(date.getDate() + n); return date; }
    function parseDate(s) { const [y,m,d]=s.split('-'); return new Date(y,m-1,d); }

    // --- DASHBOARD LOGIC ---
    function getWeeklyLoad(person, weekStart) {
        const weekEnd = addDays(weekStart, 6);
        let projectHours = 0;
        const tasks = person.tasks.filter(t => t.end >= weekStart && t.start <= weekEnd && !t.blocked);
        tasks.forEach(t => {
            const os = new Date(Math.max(t.start, weekStart));
            const oe = new Date(Math.min(t.end, weekEnd));
            const days = (oe - os)/(1000*60*60*24) + 1;
            if(days > 0) projectHours += t.dailyRate * days;
        });
        
        const standardBaseline = [3, 5].includes(person.id) ? 0 : BASELINE_HOURS; // Tim/Glen=0, others=27
        const baseline = Math.max(0, Math.min(standardBaseline, 45 - projectHours));
        const total = baseline + projectHours;

        return { baseline, project: projectHours, total };
    }

    function renderDashboard() {
        const dept = document.getElementById('engineeringView').classList.contains('active') ? 'eng' : 'qual';
        const container = document.getElementById(dept === 'eng' ? 'engDashboard' : 'qualDashboard');
        container.innerHTML = '';
        if(!window.PERSONNEL) return;
        const staff = window.PERSONNEL.filter(p => p.dept === dept);
        
        staff.forEach(p => {
            const stats = getWeeklyLoad(p, currentWeekStart);
            const projPct = Math.min(100, (stats.project/TOTAL_CAPACITY)*100);
            const actualPct = Math.round((stats.project/TOTAL_CAPACITY)*100);
            const basePct = Math.min(100-projPct, (stats.baseline/TOTAL_CAPACITY)*100);
            const isVP = [3, 5].includes(p.id) ? stats.project > 45 : stats.baseline < 27;

            let displayTasks = p.tasks.filter(t => t.end >= currentWeekStart && t.start <= addDays(currentWeekStart, 6));
            const today = new Date();
            displayTasks.sort((a,b) => {
                const aComp = a.completed || a.isDone;
                const bComp = b.completed || b.isDone;
                if(aComp !== bComp) return aComp ? 1 : -1;
                return 0;
            });

            let tasksHtml = displayTasks.map(t => {
                const isComp = t.completed || t.isDone; 
                const isLate = !isComp && t.end < today;
                const isPTO = t.type === 'PTO' || t.type === 'Holiday';
                const typeClass = isPTO ? 'type-' + t.type : 'priority-' + t.priority;
                return `
                <div class="task-item ${typeClass} ${t.blocked?'blocked':''} ${isLate?'overdue':''} ${isComp?'completed':''}">
                    <div style="display:flex; justify-content:space-between;">
                        <span class="task-desc">${t.type === 'PTO' || t.type === 'Holiday' ? 'üìÖ ' + t.type : t.category + ' - ' + t.type}</span>
                        ${isLate ? '<span class="tag tag-late">LATE</span>' : ''} ${t.blocked ? '<span class="tag tag-late">BLOCKED</span>' : ''}
                    </div>
                    <div class="task-meta">
                        ${!isPTO ? `<span class="tag">${t.qty} units</span>` : '<span class="tag tag-pto">Time Off</span>'}
                        <span>Due: ${t.end.toLocaleDateString()}</span>
                    </div>
                    ${t.details ? `<div class="task-notes">${t.details}</div>` : ''}
                    <div class="task-actions">
                        ${t.blocked ? `<button class="icon-btn" onclick="updateTaskStatus(${p.id}, ${t.id}, 'unblock')" title="Unblock" style="color:green; border-color:green;">‚ñ∂</button>` : ''}
                        <button class="icon-btn" onclick="openEdit(${p.id}, ${t.id})" title="Edit Details/Date">‚úé</button>
                        <button class="icon-btn" onclick="openHistory(${p.id}, ${t.id})" title="History">üïí</button>
                        <button class="icon-btn" onclick="openBlock(${p.id}, ${t.id})" title="Block">üö´</button>
                        ${!isComp ? `<button class="icon-btn" onclick="updateTaskStatus(${p.id}, ${t.id}, 'complete')" title="Complete">‚úÖ</button>` : ''}
                        <button class="icon-btn" onclick="updateTaskStatus(${p.id}, ${t.id}, 'delete')" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>`;
            }).join('');

            container.innerHTML += `
                <div class="person-card">
                    <div class="card-header"><h2>${p.name}</h2><div>${stats.total.toFixed(1)}h</div></div>
                    <div class="bar-container" style="${isVP ? 'background:repeating-linear-gradient(45deg,#fee2e2,#fee2e2 10px,#ef4444 10px,#ef4444 20px);' : ''}">
                        <div class="bar-seg" style="width:${basePct}%; background:var(--locked);">${stats.baseline > 1 ? stats.baseline.toFixed(1)+'h' : ''}</div>
                        <div class="bar-seg" style="width:${projPct}%; background:var(${dept==='eng'?'--primary':'--qual'});">${stats.project>0.5 ? stats.project.toFixed(1)+'h ('+actualPct+'%)' : ''}</div>
                    </div>
                    <div class="context-warning">${isVP ? '‚ö†Ô∏è VP Approval Required (Baseline < 60%)' : ''}</div>
                    <div class="task-list">${tasksHtml || '<div style="text-align:center;color:#ccc;">No tasks</div>'}</div>
                </div>
            `;
        });
    }

    // --- COMPLETED HISTORY VIEW ---
    function renderCompleted() {
        const tbody = document.querySelector('#masterHistoryTable tbody');
        tbody.innerHTML = '';
        if(!window.PERSONNEL) return;
        
        let allCompleted = [];
        window.PERSONNEL.forEach(p => {
            p.tasks.forEach(t => {
                if(t.completed || t.isDone) {
                    allCompleted.push({
                        eng: p.name, type: t.type, cat: t.category,
                        date: t.completedDate || t.end, 
                        status: t.status || "Completed",
                        pId: p.id, tId: t.id
                    });
                }
            });
        });

        allCompleted.sort((a,b) => b.date - a.date);
        allCompleted.forEach(t => {
            const statusStyle = t.status === 'Late' ? 'background:#fee2e2; color:#dc2626;' : 'background:#dcfce7; color:#166534;';
            tbody.innerHTML += `<tr><td>${t.eng}</td><td>${t.type}</td><td>${t.cat}</td><td>${t.date.toLocaleDateString()}</td><td><span class="status-pill" style="${statusStyle}">${t.status}</span></td><td><button class="icon-btn" onclick="updateTaskStatus(${t.pId}, ${t.tId}, 'reopen')">Undo</button></td></tr>`;
        });
        if(allCompleted.length === 0) tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px;">No completed history found.</td></tr>`;
    }

    // --- ACTIONS ---
    window.addTask = async (prefix) => {
        const pId = document.getElementById(`${prefix}Select`).value;
        const cat = document.getElementById(`${prefix}Cat`).value;
        const type = document.getElementById(`${prefix}Type`).value;
        const qty = parseFloat(document.getElementById(`${prefix}Qty`).value);
        const start = parseDate(document.getElementById(`${prefix}Start`).value);
        const end = parseDate(document.getElementById(`${prefix}End`).value);
        const note = document.getElementById(`${prefix}Note`).value;
        const manual = parseFloat(document.getElementById(`${prefix}Manual`).value);

        if(end < start) return alert("End < Start");
        let cost = window.CATEGORY_COSTS[cat]?.[type] || 0;
        
        if(['Other','Meeting','PTO','Holiday'].includes(type)) { 
            if(!manual) return alert("Enter total hours"); 
            cost = manual; 
        }

        const totalHours = cost * qty;
        const duration = (end - start)/(1000*60*60*24) + 1;
        const dailyRate = totalHours / Math.max(1, duration);

        // --- VP CHECK LOGIC ---
        const person = window.PERSONNEL.find(x => x.id == pId);
        const targetWeek = getMonday(start);
        
        const stats = getWeeklyLoad(person, targetWeek);
        const currentProjectLoad = stats.project;
        
        const overlapDays = Math.min(5, duration); 
        const newProjectImpact = dailyRate * overlapDays;
        const projectedProjectTotal = currentProjectLoad + newProjectImpact;
        
        let triggerVP = false;
        let warningMsg = "";

        if ([3, 5].includes(person.id)) {
            if (projectedProjectTotal > 45) {
                triggerVP = true;
                warningMsg = `This task pushes total workload to ${projectedProjectTotal.toFixed(1)}h (Limit: 45h).`;
            }
        } else {
            if (projectedProjectTotal > 18) {
                triggerVP = true;
                warningMsg = `This forces Baseline work below 60% (27h). New Project Load: ${projectedProjectTotal.toFixed(1)}h.`;
            }
        }

        if (triggerVP) {
            const confirmVP = confirm(`‚ö†Ô∏è VP Approval Required\n\n${warningMsg}\n\nDo you have VP approval to proceed?`);
            if (!confirmVP) return;
        }

        const task = {
            id: Date.now(), category: cat, type, qty, start, end, details: note,
            totalHours, dailyRate: dailyRate, costPerUnit: cost,
            priority: document.getElementById(`${prefix}Pri`).value, blocked: false, completed: false,
            history: [{date: new Date(), action: "Created"}]
        };
        await window.dbOps.updateDoc(window.dbOps.doc(window.db, "personnel", pId), { tasks: window.dbOps.arrayUnion(task) });
    }

    window.updateTaskStatus = async (pId, tId, action) => {
        const p = window.PERSONNEL.find(x => x.id === pId);
        const tasks = [...p.tasks];
        const idx = tasks.findIndex(t => t.id === tId);
        if(idx === -1) return;
        
        if(action === 'complete') {
            tasks[idx].completed = true;
            tasks[idx].completedDate = new Date();
            tasks[idx].status = tasks[idx].completedDate <= tasks[idx].end ? 'On Time' : 'Late';
            tasks[idx].history.push({date: new Date(), action: "Completed"});
        } else if(action === 'reopen') {
            tasks[idx].completed = false;
            tasks[idx].isDone = false;
            tasks[idx].history.push({date: new Date(), action: "Reopened"});
        } else if(action === 'unblock') {
            tasks[idx].blocked = false;
            tasks[idx].history.push({date: new Date(), action: "Unblocked"});
        } else if(action === 'delete') {
            tasks.splice(idx, 1);
        }
        await window.dbOps.updateDoc(window.dbOps.doc(window.db, "personnel", pId.toString()), { tasks });
        if(document.getElementById('completedView').classList.contains('active')) renderCompleted();
    }

    window.openBlock = (pId, tId) => { window.activeTaskForModal = {pId, tId}; document.getElementById('blockModal').style.display='block'; }
    
    window.confirmBlock = async () => {
        const p = window.PERSONNEL.find(x => x.id === window.activeTaskForModal.pId);
        const tasks = [...p.tasks];
        const t = tasks.find(x => x.id === window.activeTaskForModal.tId);
        t.blocked = true;
        
        const reason = document.getElementById('blockReason').value;
        if(!t.history) t.history = [];
        t.history.push({date: new Date(), action: `Blocked: ${reason || 'No reason'}`});
        
        await window.dbOps.updateDoc(window.dbOps.doc(window.db, "personnel", window.activeTaskForModal.pId.toString()), { tasks });
        closeModal('blockModal');
        document.getElementById('blockReason').value = ''; 
    }

    window.openHistory=(p,t)=>{
        document.getElementById('historyLog').innerHTML=window.PERSONNEL.find(x=>x.id===p).tasks.find(x=>x.id===t).history.map(h=>`<div style="border-bottom:1px solid #eee;padding:5px;">${new Date(h.date.toDate?h.date.toDate():h.date).toLocaleString()}: ${h.action}</div>`).join('');
        document.getElementById('historyModal').style.display='block';
    }
    window.openAssignModal=()=>{
        const sel=document.getElementById('assignTarget');sel.innerHTML='';
        window.PERSONNEL.forEach(p=>sel.add(new Option(p.name,p.id)));
        document.getElementById('assignModal').style.display='block';
    }
    window.confirmAssign=async()=>{
        const pId=document.getElementById('assignTarget').value;
        const total=parseFloat(document.getElementById('calcResult').innerText);
        const days=Math.max(1,Math.ceil(total/5));
        const task={id:Date.now(), category:document.getElementById('calcCat').value, type:document.getElementById('calcType').value, qty:document.getElementById('calcQty').value, start:new Date(), end:addDays(new Date(), days), totalHours:total, dailyRate:total/days, costPerUnit:total/document.getElementById('calcQty').value, priority:'Medium', blocked:false, history:[{date:new Date(), action:"Calc Assign"}]};
        await window.dbOps.updateDoc(window.dbOps.doc(window.db,"personnel",pId),{tasks:window.dbOps.arrayUnion(task)});
        closeModal('assignModal');
    }
    
    // NEW EDIT FUNCTIONS
    window.openEdit = (pId, tId) => {
        window.activeTaskForModal = {pId, tId};
        const p = window.PERSONNEL.find(x => x.id === pId);
        const t = p.tasks.find(x => x.id === tId);
        document.getElementById('editStart').valueAsDate = t.start;
        document.getElementById('editEnd').valueAsDate = t.end;
        document.getElementById('editDetails').value = t.details || "";
        document.getElementById('editModal').style.display = 'block';
    }

    window.saveEditTask = async () => {
        const {pId, tId} = window.activeTaskForModal;
        const p = window.PERSONNEL.find(x => x.id === pId);
        const tasks = [...p.tasks];
        const t = tasks.find(x => x.id === tId);

        const newStart = parseDate(document.getElementById('editStart').value);
        const newEnd = parseDate(document.getElementById('editEnd').value);
        if (newEnd < newStart) return alert("End date cannot be before start date");

        t.start = newStart;
        t.end = newEnd;
        t.details = document.getElementById('editDetails').value;

        // Recalc Rate
        const duration = (t.end - t.start) / (1000 * 60 * 60 * 24) + 1;
        t.dailyRate = t.totalHours / Math.max(1, duration);
        t.history.push({date: new Date(), action: "Edited Details/Date"});

        await window.dbOps.updateDoc(window.dbOps.doc(window.db, "personnel", pId.toString()), { tasks });
        closeModal('editModal');
    }

    window.closeModal=(id)=>document.getElementById(id).style.display='none';
</script>
</body>
</html>
